server {
		ssl on;
    listen 443 default ssl spdy;
    listen [::]:443 default ssl spdy;
    server_name zongl.info;

		ssl_session_cache shared:SSL:10m;
ssl_session_timeout  5m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';

ssl_prefer_server_ciphers   on;
    ssl_dhparam /etc/cert/dhparams.zongl.pem;

    ssl_certificate      /etc/cert/zonglovani.info.pem;
    ssl_certificate_key  /etc/cert/zonglovani.info.key;


		client_max_body_size 5M;

		add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload" always;
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header X-Xss-Protection "1; mode=block" always;

    server_tokens off;
    charset utf-8;
    access_log  /var/log/nginx/zonglovani.info.access.log combined buffer=32k flush=5m;
    error_log  /var/log/nginx/zonglovani.info.error.log;

		open_file_cache max=1000 inactive=20s; 
		open_file_cache_valid 60s; 
		open_file_cache_min_uses 5; 
		open_file_cache_errors off;

		location ~* ^.+\.(js|css|ico)$ {
				expires 2y;
				gzip  on;
				gzip_min_length  10;
				gzip_http_version 1.1;
				gzip_vary on;
				gzip_comp_level 6;
				gzip_proxied any;
				gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript text/x-js image/x-icon;
				gzip_disable "MSIE [1-6]\.(?!.*SV1)";
				rewrite ^/(css/|)(w|ww|)-(light|dark).css$ /css/$2-$3.css break;
				rewrite ^/(.+)-(.+).css$ /css/$1.css break;
				rewrite ^/(.+).css$ /css/$1.css break;
				rewrite ^/(.+)-(.+).js$ /js/$1.js break;
        root   /home/www/zonglovani.info;
				error_page    404 = /404.php;
				error_page    403 = /403.php;
				rewrite ^/kalendar/widget.js$ /kalendar/widget-js.php last;
			}

		location ~* ^.+\.(gif|png|jpg|jpeg|pdf|mobi|exe|msi|epub|zip|tar\.bz2)$ {
				expires 2y;
        root   /home/www/zonglovani.info;
				error_page    404 = /404.php;
				error_page    403 = /403.php;
				rewrite ^/navody/download/(.+)\.pdf$ /navody/pdf.php?file=$1 last;
				rewrite ^/lide/foto/(.+).jpg$ /lide/foto.php?id=$1 last;
				rewrite ^/lide/m/(.+)\.png$ /lide/m/monsterid.php?seed=$1 last;
				rewrite ^/kalendar/obrazek-(.*)-ts-(.+)\.(jpg|png)$ /kalendar/obrazek.php?jmeno=$2&pripona=$3 last;
				rewrite ^/kalendar/obrazek-(.+)\.(jpg|png)$ /kalendar/obrazek.php?jmeno=$1&pripona=$2 last;
			}

    location / {
        root   /home/www/zonglovani.info;
        index  index.php index.html;

				rewrite ^/micky/([23456])$ /micky/$1/ permanent;
				rewrite ^/micky/([23456])/$ /micky/$1.php last;
				rewrite ^/micky/([2345])/(.+)\.html$ /micky/$1.php?show=micky-$1-$2 last;
				rewrite ^/micky/(.+)\.html$ /micky/$1.php last;

				rewrite ^/kruhy/([234])$ /kruhy/$1/ permanent;
				rewrite ^/kruhy/([234])/$ /kruhy/$1.php last;
				rewrite ^/kruhy/([234])/(.+)\.html$ /kruhy/$1.php?show=kruhy-$1-$2 last;
				rewrite ^/kruhy/(.+)\.html$ /kruhy/$1.php last;

				rewrite ^/kuzely/([3])$ /kuzely/$1/ permanent;
				rewrite ^/kuzely/([3])/$ /kuzely/$1.php last;
				rewrite ^/kuzely/([3])/(.+)\.html$ /kuzely/$1.php?show=kuzely-$1-$2 last;
				rewrite ^/kuzely/passing$ /kuzely/passing/ permanent;
				rewrite ^/kuzely/passing/$ /kuzely/passing.php last;
				rewrite ^/kuzely/passing/(.+)\.html$ /kuzely/passing.php?show=kuzely-passing-$1 last;
				rewrite ^/kuzely/(.+)\.html$ /kuzely/$1.php last;

				rewrite ^/diabolo/(.+)\.html$ /diabolo/diabolo.php?show=diabolo-$1 last;

				rewrite ^/novinky/agregator.xml$ /novinky/index.php?rss=jo last;
				rewrite ^/rss/agregator.xml$ /novinky/agregator.xml permanent;
				rewrite ^/ostatni/changelog.rss$ https://github.com/petrkle/zonglovani.info/commits/master.atom permanent;

				rewrite ^/horoskop/zitra$ /horoskop/zitra/ permanent;
				rewrite ^/horoskop/zitra/$ /horoskop/index.php?zitra=jo last;
				rewrite ^/horoskop/zitra/(.+)\.html$ /horoskop/index.php?znameni=$1&zitra=jo last;
				rewrite ^/horoskop/popis.html$ /horoskop/popis.php last;
				rewrite ^/horoskop/(.+)\.html$ /horoskop/index.php?znameni=$1 last;

				rewrite ^/obrazky/stranka([0-9]+)\.html$ /obrazky/index.php?pageID=$1 last;
				rewrite ^/obrazky/filtr/([a-zA-Z0-9]+)$ /obrazky/index.php?filtr=$1 last;
				rewrite ^/obrazky/filtr$ /obrazky/filtr/ permanent;
				rewrite ^/obrazky/filtr/$ /obrazky/index.php?filtry last;
				rewrite ^/obrazky/([^/]+)/$ /obrazky/index.php?id=$1&pageID=1 last;
				rewrite ^/obrazky/(.+)/stranka([0-9]+)\.html$ /obrazky/index.php?id=$1&pageID=$2 last;
				rewrite ^/obrazky/(.+)/stranka([^/]+)$ /obrazky/$1/stranka$2/ permanent;
				rewrite ^/obrazky/(.+)/stranka([0-9]+)/$ /obrazky/index.php?id=$1&pageID=$2 last;
				rewrite ^/obrazky/(.+)/stranka([0-9]+)/([0-9]+)\.html$ /obrazky/index.php?id=$1&pageID=$2&photo=$3 last;
				rewrite ^/obrazky/(.+)/(.+)\.html$ /obrazky/index.php?id=$1&photo=$2 last;
				rewrite ^/obrazky/obrazky.rss$ /obrazky/index.php?rss=jo last;
				rewrite ^/obrazky/obrazky.xml$ /obrazky/index.php?rss=jo&v=2 last;

				rewrite ^/zonglovani.rss$ /rss.php last;
				rewrite ^/zonglovani.xml$ /rss.php?v=2 last;

				rewrite ^/diskuse/stranka([0-9]+)\.html$ /diskuse/index.php?pageID=$1 last;
				rewrite ^/diskuse/zpravy.rss$ /diskuse/index.php?rss=jo last;
				rewrite ^/diskuse/zpravy.xml$ /diskuse/index.php?rss=jo&v=2 last;

				rewrite ^/kalendar/udalost-(.+)\.html$ /kalendar/event.php?id=$1 last;
				rewrite ^/kalendar/smazane-(.+)\.html$ /kalendar/event.php?id=$1&deleted last;
				rewrite ^/kalendar/(....)-(.*)\.html$ /kalendar/index.php?y=$1&m=$2 last;

				rewrite ^/kalendar/widget\.html$ /kalendar/widget.php last;
				rewrite ^/kalendar/kalendar\.rss$ /kalendar/rss.php last;
				rewrite ^/kalendar/kalendar\.xml$ /kalendar/rss.php?v=2 last;
				rewrite ^/kalendar/kalendar\.ics$ /kalendar/zonglovani.ics permanent;
				rewrite ^/kalendar/zonglovani\.ics$ /kalendar/ical.php last;
				rewrite ^/kalendar/next\.json$ /kalendar/next.php?json last;
				rewrite ^/kalendar/next\.xml$ /kalendar/next.php?xml last;

				rewrite ^/kalendar/(.*)\.html$ /kalendar/$1.php last;

				rewrite ^/tip/tip\.rss$ /tip/index.php?rss=jo last;
				rewrite ^/tip/tip-img\.rss$ /tip/tip.xml permanent;
				rewrite ^/tip/tip\.xml$ /tip/index.php?imgrss=jo last;
				rewrite ^/tip/archiv1\.html$ /tip/ permanent;
				rewrite ^/tip/archiv([0-9]+)\.html$ /tip/index.php?pageID=$1 last;

				rewrite ^/mapa/kraj/(.+)/$ /mapa/index.php?kraj=$1 last;
				rewrite ^/mapa/(cr|sk)\.html$ /mapa/index.php?country=$1 last;
				rewrite ^/mapa/mapa-(.+)\.kml$ /mapa/kml-dump.php?file=$1 last;

				rewrite ^/lide/z/(.+)/(.+)/(.+).html$ /lide/obnova-hesla.php?m=$2@$1&k=$3 last;
				rewrite ^/lide/e/(.+)/(.+)/(.+).html$ /lide/zruseni.php?m=$2@$1&k=$3 last;
				rewrite ^/lide/p/(.+)/(.+)/(.+).html$ /lide/zmena-emailu.php?m=$2@$1&k=$3 last;
				rewrite ^/lide/sendmail/(.+).html$ /lide/sendmail.php?m=$1 last;
				rewrite ^/lide/dovednost$ /lide/dovednost/ permanent;
				rewrite ^/lide/dovednost/$ /lide/dovednost.php last;
				rewrite ^/lide/dovednost/(.+).html$ /lide/dovednost.php?filtr=$1 last;
				rewrite ^/lide/misto$ /lide/misto/ permanent;
				rewrite ^/lide/misto/$ /lide/misto.php last;
				rewrite ^/lide/misto/(.+).html$ /lide/misto.php?filtr=$1 last;
				rewrite ^/lide/odhlaseni/ok.html$ /lide/odhlaseni-ok.php last;
				rewrite ^/lide/stranka([^/]+)$ /lide/stranka$1/ permanent;
				rewrite ^/lide/stranka(.+)/$ /lide/index.php?pageID=$1 last;
				rewrite ^/lide/rozhovor/(.+).html$ /lide/rozhovor/index.php?id=$1 last;
				rewrite ^/lide/(.+).html$ /lide/uzivatel.php?id=$1 last;
				rewrite ^/lide/uzivatele.rss$ /lide/rss.php last;
				rewrite ^/lide/uzivatele.xml$ /lide/rss.php?v=2 last;
				rewrite ^/lide/nastaveni$ /lide/nastaveni/ permanent;
				rewrite ^/lide/nastaveni/$ /lide/nastaveni.php last;
				rewrite ^/lide/nastaveni/(.+)$ /lide/nastaveni.php?uprav=$1 last;

				rewrite ^/animace/en$ /animace/en/ permanent;
				rewrite ^/animace/en/$ /animace/index.php?nameless=jo last;
				rewrite ^/animace/en/(.+)\.html$ /animace/index.php?id=$1&nameless=jo last;
				rewrite ^/animace/siteswap$ /animace/siteswap/ permanent;
				rewrite ^/animace/siteswap/$ /animace/siteswap.php last;
				rewrite ^/animace/siteswap/(.+)\.html$ /animace/siteswap.php?id=$1 last;
				rewrite ^/animace/(.+)\.html$ /animace/index.php?id=$1 last;

				rewrite ^/navody/(.+)\.html$ /navody/$1.php last;

				rewrite ^/video/navod/info\.html$ /video/navody-info.php last;
				rewrite ^/video/stranka1\.html$ /video/ permanent;
				rewrite ^/video/([^\/]+)/stranka1\.html$ /video/$1/ permanent;
				rewrite ^/video/([^\/]+)/stranka([0-9]+)\.html$ /video/event.php?id=$1&pageID=$2 last;
				rewrite ^/video/stranka(.+)\.html$ /video/index.php?pageID=$1 last;
				rewrite ^/video/([^\/]+)/(.+)\.html$ /video/video.php?event=$1&v=$2 last;
				rewrite ^/video/(.+)\.html$ /video/video.php?v=$1 last;
				rewrite ^/video/([^\/]+)/$ /video/event.php?id=$1 last;

				rewrite ^/download/licence\.html$ /download/licence.php last;
				rewrite ^/download/(.+)\.html$ /download/index.php?id=$1 last;

				rewrite ^/ulita/(.+)\.html$ /ulita/$1.php last;

				rewrite ^/obrazky-na-plochu/(.+)\.html$ /obrazky-na-plochu/index.php?id=$1 last;

				rewrite ^/admin/detail/(.+)\.html$ /admin/index.php?detail=$1 last;

				rewrite ^/ostatni\.html$ /ostatni/index.php last;

				rewrite ^/(.*)\.html /ostatni/$1.php last;

				rewrite ^/g/(.*)$ /g/index.php?r=$1 last;

				location ~ /(mdz|olympiada|valentyn|jitka)/ {
					index index.html;
				}

				error_page    404 = /404.php;
				error_page    403 = /403.php;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    location ~ /\.ht {
			  return 403;
				error_page    403 = /403.php;
    }

    location ~ .*\.inc$ {
			  return 403;
				error_page    403 = /403.php;
    }

		location ~* /(data|tmp|lib|templates|tmp|xml|video\/klip|script\/tests|tip\/tipy.inc|ostatni\/personas|navody\/doc|vyhledavani\/set|vendor)/.*$ {
			return 403;
			error_page 403 /403.php;
		}

    location ~ \.php$ {
        root           /home/www/zonglovani.info;
        fastcgi_pass   127.0.0.1:9003;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;
				try_files $uri =404;
				error_page    404 = /404.php;
				error_page    403 = /403.php;
    }

}
server {
		ssl on;
    listen 443 ssl spdy;
    listen [::]:443 ssl spdy;
    server_name www.zongl.info;
    charset utf-8;
    server_tokens off;
    access_log  /var/log/nginx/zonglovani.info.access.log;
    return 301 https://zongl.info$request_uri;
    ssl_dhparam /etc/cert/dhparams.zongl.pem;
		add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload" always;
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header X-Xss-Protection "1; mode=block" always;
		ssl_session_cache shared:SSL:10m;
ssl_session_timeout  5m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';

ssl_prefer_server_ciphers   on;

    ssl_certificate      /etc/cert/zonglovani.info.pem;
    ssl_certificate_key  /etc/cert/zonglovani.info.key;

}

server {
		listen *:80;
		listen [::]:80;
    server_name  www.zongl.info zongl.info;
    charset utf-8;
    server_tokens off;
    access_log  /var/log/nginx/zonglovani.info.access.log;
    location / {
        return 301 https://zongl.info$request_uri; 
    }

		location /.well-known/acme-challenge {
		  alias /home/www/letsencrypt/www;
		}
}
